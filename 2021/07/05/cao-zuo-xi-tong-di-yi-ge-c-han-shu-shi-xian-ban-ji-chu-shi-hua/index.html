<!DOCTYPE HTML>
<html lang="zh-CN">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="操作系统-第一个C函数-实现板级初始化, Innovation Louke">
    <meta name="description" content="">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <!-- Global site tag (gtag.js) - Google Analytics -->


    <title>操作系统-第一个C函数-实现板级初始化 | Innovation Louke</title>
    <link rel="icon" type="image/png" href="/favicon.png">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/all.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">

    <script src="/libs/jquery/jquery.min.js"></script>

<meta name="generator" content="Hexo 5.4.0"></head>




<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">Innovation Louke</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>首页</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>标签</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>分类</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>归档</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about" class="waves-effect waves-light">
      
      <i class="fas fa-user-circle-o" style="zoom: 0.6;"></i>
      
      <span>关于</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/friends" class="waves-effect waves-light">
      
      <i class="fas fa-address-book" style="zoom: 0.6;"></i>
      
      <span>友情链接</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="" class="waves-effect waves-light">

      
      <i class="fas fa-list" style="zoom: 0.6;"></i>
      
      <span>Medias</span>
      <i class="fas fa-chevron-down" aria-hidden="true" style="zoom: 0.6;"></i>
    </a>
    <ul class="sub-nav menus_item_child ">
      
      <li>
        <a href="/music">
          
          <i class="fas fa-music" style="margin-top: -20px; zoom: 0.6;"></i>
          
          <span>Music</span>
        </a>
      </li>
      
      <li>
        <a href="/movies">
          
          <i class="fas fa-film" style="margin-top: -20px; zoom: 0.6;"></i>
          
          <span>Movies</span>
        </a>
      </li>
      
      <li>
        <a href="/books">
          
          <i class="fas fa-book" style="margin-top: -20px; zoom: 0.6;"></i>
          
          <span>Books</span>
        </a>
      </li>
      
      <li>
        <a href="/galleries">
          
          <i class="fas fa-image" style="margin-top: -20px; zoom: 0.6;"></i>
          
          <span>Galleries</span>
        </a>
      </li>
      
    </ul>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="搜索" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">Innovation Louke</div>
        <div class="logo-desc">
            
            Never really desperate, only the lost of the soul.
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			首页
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			标签
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			分类
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			归档
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-user-circle-o"></i>
			
			关于
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/friends" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-address-book"></i>
			
			友情链接
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="javascript:;">
			
				<i class="fa-fw fas fa-list"></i>
			
			Medias
			<span class="m-icon"><i class="fas fa-chevron-right"></i></span>
		</a>
            <ul  style="background:  ;" >
              
                <li>

                  <a href="/music " style="margin-left:75px">
				  
				   <i class="fa fas fa-music" style="position: absolute;left:50px" ></i>
			      
		          <span>Music</span>
                  </a>
                </li>
              
                <li>

                  <a href="/movies " style="margin-left:75px">
				  
				   <i class="fa fas fa-film" style="position: absolute;left:50px" ></i>
			      
		          <span>Movies</span>
                  </a>
                </li>
              
                <li>

                  <a href="/books " style="margin-left:75px">
				  
				   <i class="fa fas fa-book" style="position: absolute;left:50px" ></i>
			      
		          <span>Books</span>
                  </a>
                </li>
              
                <li>

                  <a href="/galleries " style="margin-left:75px">
				  
				   <i class="fa fas fa-image" style="position: absolute;left:50px" ></i>
			      
		          <span>Galleries</span>
                  </a>
                </li>
              
            </ul>
          
        </li>
        
        
    </ul>
</div>


        </div>

        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('https://pic.innnovation.cn//img/20210625223502.png')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">操作系统-第一个C函数-实现板级初始化</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        width: 345px;
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        padding: 35px 0 15px 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content {
        padding-bottom: 30px;
        overflow: auto;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;

        position: absolute;
        right: 23.5vw;
        display: block;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 15px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/OS/">
                                <span class="chip bg-color">OS</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fas fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/" class="post-category">
                                操作系统
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2021-07-05
                </div>
                

                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-check fa-fw"></i>更新日期:&nbsp;&nbsp;
                    2021-07-08
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-file-word fa-fw"></i>文章字数:&nbsp;&nbsp;
                    4.6k
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-clock fa-fw"></i>阅读时长:&nbsp;&nbsp;
                    19 分
                </div>
                

                
                    <div id="busuanzi_container_page_pv" class="info-break-policy">
                        <i class="far fa-eye fa-fw"></i>阅读次数:&nbsp;&nbsp;
                        <span id="busuanzi_value_page_pv"></span>
                    </div>
				
            </div>
        </div>
        <hr class="clearfix">

        
        <!-- 是否加载使用自带的 prismjs. -->
        <link rel="stylesheet" href="/libs/prism/prism.css">
        

        

        <div class="card-content article-card-content">
            <div id="articleContent">
                <h2 id="第一个C函数"><a href="#第一个C函数" class="headerlink" title="第一个C函数"></a>第一个C函数</h2><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">hal_start</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token comment">//第一步：初始化hal层</span>
    <span class="token comment">//第二步：初始化内核层</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>死循环避免函数返回</p>
<h2 id="hal层初始化"><a href="#hal层初始化" class="headerlink" title="hal层初始化"></a>hal层初始化</h2><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">init_hal</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token comment">//初始化平台</span>
    <span class="token comment">//初始化内存</span>
    <span class="token comment">//初始化中断</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>初始化平台、初始化内存、初始化中断的功能函数</p>
<h3 id="初始化平台"><a href="#初始化平台" class="headerlink" title="初始化平台"></a>初始化平台</h3><ol>
<li><p>把二级引导器建立的机器信息结构复制到 hal 层中的一个全局变量中，方便内核中的其它代码使用里面的信息，之后二级引导器建立的数据所占用的内存都会被释放。</p>
</li>
<li><p>要初始化图形显示驱动，内核在运行过程要在屏幕上输出信息</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">
<span class="token keyword">void</span> <span class="token function">machbstart_t_init</span><span class="token punctuation">(</span><span class="token class-name">machbstart_t</span> <span class="token operator">*</span>initp<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token comment">//清零</span>
    <span class="token function">memset</span><span class="token punctuation">(</span>initp<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token class-name">machbstart_t</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">void</span> <span class="token function">init_machbstart</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token class-name">machbstart_t</span> <span class="token operator">*</span>kmbsp <span class="token operator">=</span> <span class="token operator">&amp;</span>kmachbsp<span class="token punctuation">;</span>
    <span class="token class-name">machbstart_t</span> <span class="token operator">*</span>smbsp <span class="token operator">=</span> MBSPADR<span class="token punctuation">;</span><span class="token comment">//物理地址1MB处</span>
    <span class="token function">machbstart_t_init</span><span class="token punctuation">(</span>kmbsp<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//复制，要把地址转换成虚拟地址</span>
    <span class="token function">memcopy</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">phyadr_to_viradr</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">adr_t</span><span class="token punctuation">)</span>smbsp<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>kmbsp<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token class-name">machbstart_t</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token comment">//平台初始化函数</span>
<span class="token keyword">void</span> <span class="token function">init_halplaltform</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token comment">//复制机器信息结构</span>
    <span class="token function">init_machbstart</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//初始化图形显示驱动</span>
    <span class="token function">init_bdvideo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>kmachbsp结构体类型是 machbstart_t，这个结构和二级引导器所使用的一样</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">//全局变量定义变量放在data段</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">HAL_DEFGLOB_VARIABLE</span><span class="token expression"><span class="token punctuation">(</span>vartype<span class="token punctuation">,</span>varname<span class="token punctuation">)</span> </span><span class="token punctuation">\</span>
<span class="token expression">EXTERN  <span class="token keyword">__attribute__</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">section</span><span class="token punctuation">(</span></span><span class="token string">".data"</span><span class="token expression"><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> vartype varname</span></span>

<span class="token function">HAL_DEFGLOB_VARIABLE</span><span class="token punctuation">(</span><span class="token class-name">machbstart_t</span><span class="token punctuation">,</span>kmachbsp<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>init_bdvideo函数</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">init_bdvideo</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token class-name">dftgraph_t</span> <span class="token operator">*</span>kghp <span class="token operator">=</span> <span class="token operator">&amp;</span>kdftgh<span class="token punctuation">;</span>
    <span class="token comment">//初始化图形数据结构，里面放有图形模式，分辨率，图形驱动函数指针</span>
    <span class="token function">init_dftgraph</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//初始bga图形显卡的函数指针</span>
    <span class="token function">init_bga</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//初始vbe图形显卡的函数指针</span>
    <span class="token function">init_vbe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//清空屏幕 为黑色</span>
    <span class="token function">fill_graph</span><span class="token punctuation">(</span>kghp<span class="token punctuation">,</span> <span class="token function">BGRA</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//显示背景图片 </span>
    <span class="token function">set_charsdxwflush</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">hal_background</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>dftgraph_t结构体</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">
<span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">s_DFTGRAPH</span>
<span class="token punctuation">&#123;</span>
    <span class="token class-name">u64_t</span> gh_mode<span class="token punctuation">;</span>         <span class="token comment">//图形模式</span>
    <span class="token class-name">u64_t</span> gh_x<span class="token punctuation">;</span>            <span class="token comment">//水平像素点</span>
    <span class="token class-name">u64_t</span> gh_y<span class="token punctuation">;</span>            <span class="token comment">//垂直像素点</span>
    <span class="token class-name">u64_t</span> gh_framphyadr<span class="token punctuation">;</span>   <span class="token comment">//显存物理地址 </span>
    <span class="token class-name">u64_t</span> gh_fvrmphyadr<span class="token punctuation">;</span>   <span class="token comment">//显存虚拟地址</span>
    <span class="token class-name">u64_t</span> gh_fvrmsz<span class="token punctuation">;</span>       <span class="token comment">//显存大小</span>
    <span class="token class-name">u64_t</span> gh_onepixbits<span class="token punctuation">;</span>   <span class="token comment">//一个像素字占用的数据位数</span>
    <span class="token class-name">u64_t</span> gh_onepixbyte<span class="token punctuation">;</span>
    <span class="token class-name">u64_t</span> gh_vbemodenr<span class="token punctuation">;</span>    <span class="token comment">//vbe模式号</span>
    <span class="token class-name">u64_t</span> gh_bank<span class="token punctuation">;</span>         <span class="token comment">//显存的bank数</span>
    <span class="token class-name">u64_t</span> gh_curdipbnk<span class="token punctuation">;</span>    <span class="token comment">//当前bank</span>
    <span class="token class-name">u64_t</span> gh_nextbnk<span class="token punctuation">;</span>      <span class="token comment">//下一个bank</span>
    <span class="token class-name">u64_t</span> gh_banksz<span class="token punctuation">;</span>       <span class="token comment">//bank大小</span>
    <span class="token class-name">u64_t</span> gh_fontadr<span class="token punctuation">;</span>      <span class="token comment">//字库地址</span>
    <span class="token class-name">u64_t</span> gh_fontsz<span class="token punctuation">;</span>       <span class="token comment">//字库大小</span>
    <span class="token class-name">u64_t</span> gh_fnthight<span class="token punctuation">;</span>     <span class="token comment">//字体高度</span>
    <span class="token class-name">u64_t</span> gh_nxtcharsx<span class="token punctuation">;</span>    <span class="token comment">//下一字符显示的x坐标</span>
    <span class="token class-name">u64_t</span> gh_nxtcharsy<span class="token punctuation">;</span>    <span class="token comment">//下一字符显示的y坐标</span>
    <span class="token class-name">u64_t</span> gh_linesz<span class="token punctuation">;</span>       <span class="token comment">//字符行高</span>
    <span class="token class-name">pixl_t</span> gh_deffontpx<span class="token punctuation">;</span>   <span class="token comment">//默认字体大小</span>
    <span class="token class-name">u64_t</span> gh_chardxw<span class="token punctuation">;</span>
    <span class="token class-name">u64_t</span> gh_flush<span class="token punctuation">;</span>
    <span class="token class-name">u64_t</span> gh_framnr<span class="token punctuation">;</span>
    <span class="token class-name">u64_t</span> gh_fshdata<span class="token punctuation">;</span>      <span class="token comment">//刷新相关的</span>
    <span class="token class-name">dftghops_t</span> gh_opfun<span class="token punctuation">;</span>   <span class="token comment">//图形驱动操作函数指针结构体</span>
<span class="token punctuation">&#125;</span><span class="token class-name">dftgraph_t</span><span class="token punctuation">;</span>
<span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">s_DFTGHOPS</span>
<span class="token punctuation">&#123;</span>
    <span class="token comment">//读写显存数据</span>
    <span class="token class-name">size_t</span> <span class="token punctuation">(</span><span class="token operator">*</span>dgo_read<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> ghpdev<span class="token punctuation">,</span><span class="token keyword">void</span><span class="token operator">*</span> outp<span class="token punctuation">,</span><span class="token class-name">size_t</span> rdsz<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">size_t</span> <span class="token punctuation">(</span><span class="token operator">*</span>dgo_write<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> ghpdev<span class="token punctuation">,</span><span class="token keyword">void</span><span class="token operator">*</span> inp<span class="token punctuation">,</span><span class="token class-name">size_t</span> wesz<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">sint_t</span> <span class="token punctuation">(</span><span class="token operator">*</span>dgo_ioctrl<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> ghpdev<span class="token punctuation">,</span><span class="token keyword">void</span><span class="token operator">*</span> outp<span class="token punctuation">,</span><span class="token class-name">uint_t</span> iocode<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//刷新</span>
    <span class="token keyword">void</span>   <span class="token punctuation">(</span><span class="token operator">*</span>dgo_flush<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> ghpdev<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">sint_t</span> <span class="token punctuation">(</span><span class="token operator">*</span>dgo_set_bank<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> ghpdev<span class="token punctuation">,</span> <span class="token class-name">sint_t</span> bnr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//读写像素</span>
    <span class="token class-name">pixl_t</span> <span class="token punctuation">(</span><span class="token operator">*</span>dgo_readpix<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> ghpdev<span class="token punctuation">,</span><span class="token class-name">uint_t</span> x<span class="token punctuation">,</span><span class="token class-name">uint_t</span> y<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span>   <span class="token punctuation">(</span><span class="token operator">*</span>dgo_writepix<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> ghpdev<span class="token punctuation">,</span><span class="token class-name">pixl_t</span> pix<span class="token punctuation">,</span><span class="token class-name">uint_t</span> x<span class="token punctuation">,</span><span class="token class-name">uint_t</span> y<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//直接读写像素 </span>
    <span class="token class-name">pixl_t</span> <span class="token punctuation">(</span><span class="token operator">*</span>dgo_dxreadpix<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> ghpdev<span class="token punctuation">,</span><span class="token class-name">uint_t</span> x<span class="token punctuation">,</span><span class="token class-name">uint_t</span> y<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span>   <span class="token punctuation">(</span><span class="token operator">*</span>dgo_dxwritepix<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> ghpdev<span class="token punctuation">,</span><span class="token class-name">pixl_t</span> pix<span class="token punctuation">,</span><span class="token class-name">uint_t</span> x<span class="token punctuation">,</span><span class="token class-name">uint_t</span> y<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//设置x，y坐标和偏移</span>
    <span class="token class-name">sint_t</span> <span class="token punctuation">(</span><span class="token operator">*</span>dgo_set_xy<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> ghpdev<span class="token punctuation">,</span><span class="token class-name">uint_t</span> x<span class="token punctuation">,</span><span class="token class-name">uint_t</span> y<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">sint_t</span> <span class="token punctuation">(</span><span class="token operator">*</span>dgo_set_vwh<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> ghpdev<span class="token punctuation">,</span><span class="token class-name">uint_t</span> vwt<span class="token punctuation">,</span><span class="token class-name">uint_t</span> vhi<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">sint_t</span> <span class="token punctuation">(</span><span class="token operator">*</span>dgo_set_xyoffset<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> ghpdev<span class="token punctuation">,</span><span class="token class-name">uint_t</span> xoff<span class="token punctuation">,</span><span class="token class-name">uint_t</span> yoff<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//获取x，y坐标和偏移</span>
    <span class="token class-name">sint_t</span> <span class="token punctuation">(</span><span class="token operator">*</span>dgo_get_xy<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> ghpdev<span class="token punctuation">,</span><span class="token class-name">uint_t</span><span class="token operator">*</span> rx<span class="token punctuation">,</span><span class="token class-name">uint_t</span><span class="token operator">*</span> ry<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">sint_t</span> <span class="token punctuation">(</span><span class="token operator">*</span>dgo_get_vwh<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> ghpdev<span class="token punctuation">,</span><span class="token class-name">uint_t</span><span class="token operator">*</span> rvwt<span class="token punctuation">,</span><span class="token class-name">uint_t</span><span class="token operator">*</span> rvhi<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">sint_t</span> <span class="token punctuation">(</span><span class="token operator">*</span>dgo_get_xyoffset<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> ghpdev<span class="token punctuation">,</span><span class="token class-name">uint_t</span><span class="token operator">*</span> rxoff<span class="token punctuation">,</span><span class="token class-name">uint_t</span><span class="token operator">*</span> ryoff<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token class-name">dftghops_t</span><span class="token punctuation">;</span>
<span class="token comment">//刷新显存</span>
<span class="token keyword">void</span> <span class="token function">flush_videoram</span><span class="token punctuation">(</span><span class="token class-name">dftgraph_t</span> <span class="token operator">*</span>kghp<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    kghp<span class="token operator">-></span>gh_opfun<span class="token punctuation">.</span><span class="token function">dgo_flush</span><span class="token punctuation">(</span>kghp<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>最后调用函数</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">//在halinit.c文件中</span>
<span class="token keyword">void</span> <span class="token function">init_hal</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token function">init_halplaltform</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token comment">//在hal_start.c文件中</span>
<span class="token keyword">void</span> <span class="token function">hal_start</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token function">init_hal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//初始化hal层，其中会调用初始化平台函数，在那里会调用初始化图形驱动</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
</ol>
<h3 id="初始化内存"><a href="#初始化内存" class="headerlink" title="初始化内存"></a>初始化内存</h3><p>相比较二级引导器的内存布局信息，内存管理器需要保存更多的信息，最好是顺序的内存布局信息，这样可以增加额外的功能属性，同时降低代码的复杂度。</p>
<p>定义结构<code>s_PHYMMARGE</code></p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PMR_T_OSAPUSERRAM</span> <span class="token expression"><span class="token number">1</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PMR_T_RESERVRAM</span> <span class="token expression"><span class="token number">2</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PMR_T_HWUSERRAM</span> <span class="token expression"><span class="token number">8</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PMR_T_ARACONRAM</span> <span class="token expression"><span class="token number">0xf</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PMR_T_BUGRAM</span> <span class="token expression"><span class="token number">0xff</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PMR_F_X86_32</span> <span class="token expression"><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">0</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PMR_F_X86_64</span> <span class="token expression"><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">1</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PMR_F_ARM_32</span> <span class="token expression"><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">2</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PMR_F_ARM_64</span> <span class="token expression"><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">3</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PMR_F_HAL_MASK</span> <span class="token expression"><span class="token number">0xff</span></span></span>

<span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">s_PHYMMARGE</span>
<span class="token punctuation">&#123;</span>
    <span class="token class-name">spinlock_t</span> pmr_lock<span class="token punctuation">;</span><span class="token comment">//保护这个结构是自旋锁</span>
    <span class="token class-name">u32_t</span> pmr_type<span class="token punctuation">;</span>     <span class="token comment">//内存地址空间类型</span>
    <span class="token class-name">u32_t</span> pmr_stype<span class="token punctuation">;</span>
    <span class="token class-name">u32_t</span> pmr_dtype<span class="token punctuation">;</span>    <span class="token comment">//内存地址空间的子类型，见上面的宏</span>
    <span class="token class-name">u32_t</span> pmr_flgs<span class="token punctuation">;</span>     <span class="token comment">//结构的标志与状态</span>
    <span class="token class-name">u32_t</span> pmr_stus<span class="token punctuation">;</span>
    <span class="token class-name">u64_t</span> pmr_saddr<span class="token punctuation">;</span>    <span class="token comment">//内存空间的开始地址</span>
    <span class="token class-name">u64_t</span> pmr_lsize<span class="token punctuation">;</span>    <span class="token comment">//内存空间的大小</span>
    <span class="token class-name">u64_t</span> pmr_end<span class="token punctuation">;</span>      <span class="token comment">//内存空间的结束地址</span>
    <span class="token class-name">u64_t</span> pmr_rrvmsaddr<span class="token punctuation">;</span><span class="token comment">//内存保留空间的开始地址</span>
    <span class="token class-name">u64_t</span> pmr_rrvmend<span class="token punctuation">;</span>  <span class="token comment">//内存保留空间的结束地址</span>
    <span class="token keyword">void</span><span class="token operator">*</span> pmr_prip<span class="token punctuation">;</span>     <span class="token comment">//结构的私有数据指针，以后扩展所用</span>
    <span class="token keyword">void</span><span class="token operator">*</span> pmr_extp<span class="token punctuation">;</span>     <span class="token comment">//结构的扩展数据指针，以后扩展所用</span>
<span class="token punctuation">&#125;</span><span class="token class-name">phymmarge_t</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>有些情况下内核要另起炉灶，不想把所有的内存空间都交给内存管理器去管理，所以要保留一部分内存空间，这就是上面结构中那两个 pmr_rrvmsaddr、pmr_rrvmend 字段的作用。</p>
<p>有了数据结构，我们还要写代码来操作它：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token class-name">u64_t</span> <span class="token function">initpmrge_core</span><span class="token punctuation">(</span><span class="token class-name">e820map_t</span> <span class="token operator">*</span>e8sp<span class="token punctuation">,</span> <span class="token class-name">u64_t</span> e8nr<span class="token punctuation">,</span> <span class="token class-name">phymmarge_t</span> <span class="token operator">*</span>pmargesp<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token class-name">u64_t</span> retnr <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">u64_t</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> e8nr<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token comment">//根据一个e820map_t结构建立一个phymmarge_t结构</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">init_one_pmrge</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>e8sp<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>pmargesp<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> FALSE<span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> retnr<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        retnr<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">return</span> retnr<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">void</span> <span class="token function">init_phymmarge</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token class-name">machbstart_t</span> <span class="token operator">*</span>mbsp <span class="token operator">=</span> <span class="token operator">&amp;</span>kmachbsp<span class="token punctuation">;</span>
    <span class="token class-name">phymmarge_t</span> <span class="token operator">*</span>pmarge_adr <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token class-name">u64_t</span> pmrgesz <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token comment">//根据machbstart_t机器信息结构计算获得phymmarge_t结构的开始地址和大小</span>
    <span class="token function">ret_phymmarge_adrandsz</span><span class="token punctuation">(</span>mbsp<span class="token punctuation">,</span> <span class="token operator">&amp;</span>pmarge_adr<span class="token punctuation">,</span> <span class="token operator">&amp;</span>pmrgesz<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">u64_t</span> tmppmrphyadr <span class="token operator">=</span> mbsp<span class="token operator">-></span>mb_nextwtpadr<span class="token punctuation">;</span>
    <span class="token class-name">e820map_t</span> <span class="token operator">*</span>e8p <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">e820map_t</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">adr_t</span><span class="token punctuation">)</span><span class="token punctuation">(</span>mbsp<span class="token operator">-></span>mb_e820padr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//建立phymmarge_t结构</span>
    <span class="token class-name">u64_t</span> ipmgnr <span class="token operator">=</span> <span class="token function">initpmrge_core</span><span class="token punctuation">(</span>e8p<span class="token punctuation">,</span> mbsp<span class="token operator">-></span>mb_e820nr<span class="token punctuation">,</span> pmarge_adr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//把phymmarge_t结构的地址大小个数保存machbstart_t机器信息结构中</span>
    mbsp<span class="token operator">-></span>mb_e820expadr <span class="token operator">=</span> tmppmrphyadr<span class="token punctuation">;</span>
    mbsp<span class="token operator">-></span>mb_e820exnr <span class="token operator">=</span> ipmgnr<span class="token punctuation">;</span>
    mbsp<span class="token operator">-></span>mb_e820exsz <span class="token operator">=</span> ipmgnr <span class="token operator">*</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token class-name">phymmarge_t</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    mbsp<span class="token operator">-></span>mb_nextwtpadr <span class="token operator">=</span> <span class="token function">PAGE_ALIGN</span><span class="token punctuation">(</span>mbsp<span class="token operator">-></span>mb_e820expadr <span class="token operator">+</span> mbsp<span class="token operator">-></span>mb_e820exsz<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//phymmarge_t结构中地址空间从低到高进行排序，我已经帮你写好了</span>
    <span class="token function">phymmarge_sort</span><span class="token punctuation">(</span>pmarge_adr<span class="token punctuation">,</span> ipmgnr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>根据 e820map_t 结构数组，建立了一个 phymmarge_t 结构数组，init_one_pmrge 函数正是把 e820map_t 结构中的信息复制到 phymmarge_t 结构中来。</p>
<p>调用</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">init_halmm</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token function">init_phymmarge</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//init_memmgr();</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h3 id="初始化中断"><a href="#初始化中断" class="headerlink" title="初始化中断"></a>初始化中断</h3><p>在 x86 CPU 上，最多支持 256 个中断，还记得前面所说的中断表和中断门描述符吗，这意味着我们要准备 256 个中断门描述符和 256 个中断处理程序的入口。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">s_GATE</span>
<span class="token punctuation">&#123;</span>
        <span class="token class-name">u16_t</span>   offset_low<span class="token punctuation">;</span>     <span class="token comment">/* 偏移 */</span>
        <span class="token class-name">u16_t</span>   selector<span class="token punctuation">;</span>       <span class="token comment">/* 段选择子 */</span>
        <span class="token class-name">u8_t</span>    dcount<span class="token punctuation">;</span>         <span class="token comment">/* 该字段只在调用门描述符中有效。如果在利用调用门调用子程序时引起特权级的转换和堆栈的改变，需要将外层堆栈中的参数复制到内层堆栈。该双字计数字段就是用于说明这种情况发生时，要复制的双字参数的数量。*/</span>
        <span class="token class-name">u8_t</span>    attr<span class="token punctuation">;</span>           <span class="token comment">/* P(1) DPL(2) DT(1) TYPE(4) */</span>
        <span class="token class-name">u16_t</span>   offset_high<span class="token punctuation">;</span>    <span class="token comment">/* 偏移的高位段 */</span>
        <span class="token class-name">u32_t</span>   offset_high_h<span class="token punctuation">;</span>
        <span class="token class-name">u32_t</span>   offset_resv<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token keyword">__attribute__</span><span class="token punctuation">(</span><span class="token punctuation">(</span>packed<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token class-name">gate_t</span><span class="token punctuation">;</span>
<span class="token comment">//定义中断表</span>
<span class="token function">HAL_DEFGLOB_VARIABLE</span><span class="token punctuation">(</span><span class="token class-name">gate_t</span><span class="token punctuation">,</span>x64_idt<span class="token punctuation">)</span><span class="token punctuation">[</span>IDTMAX<span class="token punctuation">]</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>中断表其实是个 gate_t 结构的数组，由 CPU 的 IDTR 寄存器指向，IDTMAX 为 256</p>
<p>定义函数给中断表设置数据</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">//vector 向量也是中断号</span>
<span class="token comment">//desc_type 中断门类型，中断门，陷阱门</span>
<span class="token comment">//handler 中断处理程序的入口地址</span>
<span class="token comment">//privilege 中断门的权限级别</span>
<span class="token keyword">void</span> <span class="token function">set_idt_desc</span><span class="token punctuation">(</span><span class="token class-name">u8_t</span> vector<span class="token punctuation">,</span> <span class="token class-name">u8_t</span> desc_type<span class="token punctuation">,</span> <span class="token class-name">inthandler_t</span> handler<span class="token punctuation">,</span> <span class="token class-name">u8_t</span> privilege<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token class-name">gate_t</span> <span class="token operator">*</span>p_gate <span class="token operator">=</span> <span class="token operator">&amp;</span>x64_idt<span class="token punctuation">[</span>vector<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token class-name">u64_t</span> base <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">u64_t</span><span class="token punctuation">)</span>handler<span class="token punctuation">;</span>
    p_gate<span class="token operator">-></span>offset_low <span class="token operator">=</span> base <span class="token operator">&amp;</span> <span class="token number">0xFFFF</span><span class="token punctuation">;</span>
    p_gate<span class="token operator">-></span>selector <span class="token operator">=</span> SELECTOR_KERNEL_CS<span class="token punctuation">;</span>
    p_gate<span class="token operator">-></span>dcount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    p_gate<span class="token operator">-></span>attr <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">u8_t</span><span class="token punctuation">)</span><span class="token punctuation">(</span>desc_type <span class="token operator">|</span> <span class="token punctuation">(</span>privilege <span class="token operator">&lt;&lt;</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    p_gate<span class="token operator">-></span>offset_high <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">u16_t</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span>base <span class="token operator">>></span> <span class="token number">16</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xFFFF</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    p_gate<span class="token operator">-></span>offset_high_h <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">u32_t</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span>base <span class="token operator">>></span> <span class="token number">32</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xffffffff</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    p_gate<span class="token operator">-></span>offset_resv <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>上面的代码，正是按照要求，把这些数据填入中断门描述符中的。有了中断门之后，还差中断处理程序，中断处理程序只负责这三件事：</p>
<ol>
<li>保护 CPU 寄存器，即中断发生时的程序运行的上下文。</li>
<li>调用中断处理程序，这个程序可以是修复异常的，可以是设备驱动程序中对设备响应的程序。</li>
<li>恢复 CPU 寄存器，即恢复中断时程序运行的上下文，使程序继续运行。</li>
</ol>
<p>先来写好完成以上三个功能的汇编宏代码，避免写 256 遍同样的代码，代码如下</p>
<pre class="line-numbers language-assembly" data-language="assembly"><code class="language-assembly">&#x2F;&#x2F;保存中断后的寄存器
%macro  SAVEALL  0
  push rax
  push rbx
  push rcx
  push rdx
  push rbp
  push rsi
  push rdi
  push r8
  push r9
  push r10
  push r11
  push r12
  push r13
  push r14
  push r15
  xor r14,r14
  mov r14w,ds
  push r14
  mov r14w,es
  push r14
  mov r14w,fs
  push r14
  mov r14w,gs
  push r14
%endmacro
&#x2F;&#x2F;恢复中断后寄存器
%macro  RESTOREALL  0
  pop r14
  mov gs,r14w
  pop r14 
  mov fs,r14w
  pop r14
  mov es,r14w
  pop r14
  mov ds,r14w
  pop r15
  pop r14
  pop r13
  pop r12
  pop r11
  pop r10
  pop r9
  pop r8
  pop rdi
  pop rsi
  pop rbp
  pop rdx
  pop rcx
  pop rbx
  pop rax
  iretq
%endmacro
&#x2F;&#x2F;保存异常下的寄存器
%macro  SAVEALLFAULT 0
  push rax
  push rbx
  push rcx
  push rdx
  push rbp
  push rsi
  push rdi
  push r8
  push r9
  push r10
  push r11
  push r12
  push r13
  push r14
  push r15
  xor r14,r14
  mov r14w,ds
  push r14
  mov r14w,es
  push r14
  mov r14w,fs
  push r14
  mov r14w,gs
  push r14
%endmacro
&#x2F;&#x2F;恢复异常下寄存器
%macro  RESTOREALLFAULT  0
  pop r14
  mov gs,r14w
  pop r14 
  mov fs,r14w
  pop r14
  mov es,r14w
  pop r14
  mov ds,r14w
  pop r15
  pop r14
  pop r13
  pop r12
  pop r11
  pop r10
  pop r9
  pop r8
  pop rdi
  pop rsi
  pop rbp
  pop rdx
  pop rcx
  pop rbx
  pop rax
  add rsp,8
  iretq
%endmacro
&#x2F;&#x2F;没有错误码CPU异常
%macro  SRFTFAULT 1
  push    _NOERRO_CODE
  SAVEALLFAULT
  mov r14w,0x10
  mov ds,r14w
  mov es,r14w
  mov fs,r14w
  mov gs,r14w
  mov   rdi,%1 ;rdi, rsi
  mov   rsi,rsp
  call   hal_fault_allocator
  RESTOREALLFAULT
%endmacro
&#x2F;&#x2F;CPU异常
%macro  SRFTFAULT_ECODE 1
  SAVEALLFAULT
  mov r14w,0x10
  mov ds,r14w
  mov es,r14w
  mov fs,r14w
  mov gs,r14w
  mov   rdi,%1
  mov   rsi,rsp
  call   hal_fault_allocator
  RESTOREALLFAULT
%endmacro
&#x2F;&#x2F;硬件中断
%macro  HARWINT  1
  SAVEALL
  mov r14w,0x10
  mov ds,r14w
  mov es,r14w
  mov fs,r14w
  mov gs,r14w
  mov  rdi, %1
  mov   rsi,rsp
  call    hal_intpt_allocator
  RESTOREALL
%endmacro<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>有的 CPU 异常，CPU 自动把异常码压入到栈中，而有的 CPU 异常没有异常码，为了统一，我们对没有异常码的<strong>手动压入一个常数，维持栈的平衡</strong>。</p>
<p>有了中断异常处理的宏，我们还要它们变成中断异常的处理程序入口点函数。汇编函数其实就是一个标号加一段汇编代码，C 编译器把 C 语言函数编译成汇编代码后，也是标号加汇编代码，函数名就是标号</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">
<span class="token comment">//除法错误异常 比如除0</span>
exc_divide_error<span class="token operator">:</span>
  SRFTFAULT <span class="token number">0</span>
<span class="token comment">//单步执行异常</span>
exc_single_step_exception<span class="token operator">:</span>
  SRFTFAULT <span class="token number">1</span>
exc_nmi<span class="token operator">:</span>
  SRFTFAULT <span class="token number">2</span>
<span class="token comment">//调试断点异常</span>
exc_breakpoint_exception<span class="token operator">:</span>
  SRFTFAULT <span class="token number">3</span>
<span class="token comment">//溢出异常</span>
exc_overflow<span class="token operator">:</span>
  SRFTFAULT <span class="token number">4</span>
<span class="token comment">//段不存在异常</span>
exc_segment_not_present<span class="token operator">:</span>
  SRFTFAULT_ECODE <span class="token number">11</span>
<span class="token comment">//栈异常</span>
exc_stack_exception<span class="token operator">:</span>
  SRFTFAULT_ECODE <span class="token number">12</span>
<span class="token comment">//通用异常</span>
exc_general_protection<span class="token operator">:</span>
  SRFTFAULT_ECODE <span class="token number">13</span>
<span class="token comment">//缺页异常</span>
exc_page_fault<span class="token operator">:</span>
  SRFTFAULT_ECODE <span class="token number">14</span>
hxi_exc_general_intpfault<span class="token operator">:</span>
  SRFTFAULT <span class="token number">256</span>
<span class="token comment">//硬件1～7号中断</span>
hxi_hwint00<span class="token operator">:</span>
  <span class="token function">HARWINT</span>  <span class="token punctuation">(</span>INT_VECTOR_IRQ0<span class="token operator">+</span><span class="token number">0</span><span class="token punctuation">)</span>
hxi_hwint01<span class="token operator">:</span>
  <span class="token function">HARWINT</span>  <span class="token punctuation">(</span>INT_VECTOR_IRQ0<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span>
hxi_hwint02<span class="token operator">:</span>
  <span class="token function">HARWINT</span>  <span class="token punctuation">(</span>INT_VECTOR_IRQ0<span class="token operator">+</span><span class="token number">2</span><span class="token punctuation">)</span>
hxi_hwint03<span class="token operator">:</span>
  <span class="token function">HARWINT</span>  <span class="token punctuation">(</span>INT_VECTOR_IRQ0<span class="token operator">+</span><span class="token number">3</span><span class="token punctuation">)</span>
hxi_hwint04<span class="token operator">:</span>
  <span class="token function">HARWINT</span>  <span class="token punctuation">(</span>INT_VECTOR_IRQ0<span class="token operator">+</span><span class="token number">4</span><span class="token punctuation">)</span>
hxi_hwint05<span class="token operator">:</span>
  <span class="token function">HARWINT</span>  <span class="token punctuation">(</span>INT_VECTOR_IRQ0<span class="token operator">+</span><span class="token number">5</span><span class="token punctuation">)</span>
hxi_hwint06<span class="token operator">:</span>
  <span class="token function">HARWINT</span>  <span class="token punctuation">(</span>INT_VECTOR_IRQ0<span class="token operator">+</span><span class="token number">6</span><span class="token punctuation">)</span>
hxi_hwint07<span class="token operator">:</span>
  <span class="token function">HARWINT</span>  <span class="token punctuation">(</span>INT_VECTOR_IRQ0<span class="token operator">+</span><span class="token number">7</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>有了中断程序入口地址，就可以设置中断门描述符</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">init_idt_descriptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
<span class="token comment">//一开始把所有中断的处理程序设置为保留的通用处理程序</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">u16_t</span> intindx <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> intindx <span class="token operator">&lt;=</span> <span class="token number">255</span><span class="token punctuation">;</span> intindx<span class="token operator">++</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token function">set_idt_desc</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">u8_t</span><span class="token punctuation">)</span>intindx<span class="token punctuation">,</span> DA_386IGate<span class="token punctuation">,</span> hxi_exc_general_intpfault<span class="token punctuation">,</span> PRIVILEGE_KRNL<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token function">set_idt_desc</span><span class="token punctuation">(</span>INT_VECTOR_DIVIDE<span class="token punctuation">,</span> DA_386IGate<span class="token punctuation">,</span> exc_divide_error<span class="token punctuation">,</span> PRIVILEGE_KRNL<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">set_idt_desc</span><span class="token punctuation">(</span>INT_VECTOR_DEBUG<span class="token punctuation">,</span> DA_386IGate<span class="token punctuation">,</span> exc_single_step_exception<span class="token punctuation">,</span> PRIVILEGE_KRNL<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">set_idt_desc</span><span class="token punctuation">(</span>INT_VECTOR_NMI<span class="token punctuation">,</span> DA_386IGate<span class="token punctuation">,</span> exc_nmi<span class="token punctuation">,</span> PRIVILEGE_KRNL<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">set_idt_desc</span><span class="token punctuation">(</span>INT_VECTOR_BREAKPOINT<span class="token punctuation">,</span> DA_386IGate<span class="token punctuation">,</span> exc_breakpoint_exception<span class="token punctuation">,</span> PRIVILEGE_USER<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">set_idt_desc</span><span class="token punctuation">(</span>INT_VECTOR_OVERFLOW<span class="token punctuation">,</span> DA_386IGate<span class="token punctuation">,</span> exc_overflow<span class="token punctuation">,</span> PRIVILEGE_USER<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//篇幅所限，未全部展示</span>
    <span class="token function">set_idt_desc</span><span class="token punctuation">(</span>INT_VECTOR_PAGE_FAULT<span class="token punctuation">,</span> DA_386IGate<span class="token punctuation">,</span> exc_page_fault<span class="token punctuation">,</span> PRIVILEGE_KRNL<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">set_idt_desc</span><span class="token punctuation">(</span>INT_VECTOR_IRQ0 <span class="token operator">+</span> <span class="token number">0</span><span class="token punctuation">,</span> DA_386IGate<span class="token punctuation">,</span> hxi_hwint00<span class="token punctuation">,</span> PRIVILEGE_KRNL<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">set_idt_desc</span><span class="token punctuation">(</span>INT_VECTOR_IRQ0 <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> DA_386IGate<span class="token punctuation">,</span> hxi_hwint01<span class="token punctuation">,</span> PRIVILEGE_KRNL<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">set_idt_desc</span><span class="token punctuation">(</span>INT_VECTOR_IRQ0 <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">,</span> DA_386IGate<span class="token punctuation">,</span> hxi_hwint02<span class="token punctuation">,</span> PRIVILEGE_KRNL<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">set_idt_desc</span><span class="token punctuation">(</span>INT_VECTOR_IRQ0 <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">,</span> DA_386IGate<span class="token punctuation">,</span> hxi_hwint03<span class="token punctuation">,</span> PRIVILEGE_KRNL<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//篇幅所限，未全部展示</span>
     <span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>调用</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">init_halintupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token function">init_idt_descriptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">init_intfltdsc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>但是，前面我们只是解决了中断的 CPU 相关部分，而 CPU 只是响应中断，但是并不能解决产生中断的问题。比如缺页中断来了，我们要解决内存地址映射关系，程序才可以继续运行。再比如硬盘中断来了，我们要读取硬盘的数据，要处理这问题，就要写好相应的处理函数。</p>
<p><img src="https://static001.geekbang.org/resource/image/fd/7a/fd2cd9e5b63cd7e52cd68b65e81aee7a.jpg" alt="中断框架设计图"></p>
<p>中断异常描述符</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">s_INTFLTDSC</span><span class="token punctuation">&#123;</span>    
    <span class="token class-name">spinlock_t</span>  i_lock<span class="token punctuation">;</span>    
    <span class="token class-name">u32_t</span>       i_flg<span class="token punctuation">;</span>    
    <span class="token class-name">u32_t</span>       i_stus<span class="token punctuation">;</span>    
    <span class="token class-name">uint_t</span>      i_prity<span class="token punctuation">;</span>        <span class="token comment">//中断优先级    </span>
    <span class="token class-name">uint_t</span>      i_irqnr<span class="token punctuation">;</span>        <span class="token comment">//中断号    </span>
    <span class="token class-name">uint_t</span>      i_deep<span class="token punctuation">;</span>         <span class="token comment">//中断嵌套深度    </span>
    <span class="token class-name">u64_t</span>       i_indx<span class="token punctuation">;</span>         <span class="token comment">//中断计数    </span>
    <span class="token class-name">list_h_t</span>    i_serlist<span class="token punctuation">;</span>      <span class="token comment">//也可以使用中断回调函数的方式</span>
    <span class="token class-name">uint_t</span>      i_sernr<span class="token punctuation">;</span>        <span class="token comment">//中断回调函数个数   </span>
    <span class="token class-name">list_h_t</span>    i_serthrdlst<span class="token punctuation">;</span>   <span class="token comment">//中断线程链表头    </span>
    <span class="token class-name">uint_t</span>      i_serthrdnr<span class="token punctuation">;</span>    <span class="token comment">//中断线程个数    </span>
    <span class="token keyword">void</span><span class="token operator">*</span>       i_onethread<span class="token punctuation">;</span>    <span class="token comment">//只有一个中断线程时直接用指针    </span>
    <span class="token keyword">void</span><span class="token operator">*</span>       i_rbtreeroot<span class="token punctuation">;</span>   <span class="token comment">//如果中断线程太多则按优先级组成红黑树</span>
    <span class="token class-name">list_h_t</span>    i_serfisrlst<span class="token punctuation">;</span>      
    <span class="token class-name">uint_t</span>      i_serfisrnr<span class="token punctuation">;</span>       
    <span class="token keyword">void</span><span class="token operator">*</span>       i_msgmpool<span class="token punctuation">;</span>     <span class="token comment">//可能的中断消息池    </span>
    <span class="token keyword">void</span><span class="token operator">*</span>       i_privp<span class="token punctuation">;</span>    
    <span class="token keyword">void</span><span class="token operator">*</span>       i_extp<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token class-name">intfltdsc_t</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>如果内核或者设备驱动程序要安装一个中断处理函数，就要先申请一个 intserdsc_t 结构体，然后把中断函数的地址写入其中，最后把这个结构挂载到对应的 intfltdsc_t 结构中的 i_serfisrlst 链表中。</p>
<p>为什么不能直接把中断处理函数放在 intfltdsc_t 结构中呢，还要多此一举搞个 intserdsc_t 结构体呢？</p>
<p>因为我们的计算机中可能有很多设备，每个设备都可能产生中断，但是中断控制器的中断信号线是有限的。你可以这样理解：中断控制器最多只能产生几十号中断号，而设备不止几十个，所以会有多个设备共享一根中断信号线。这就导致一个中断发生后，无法确定是哪个设备产生的中断，所以我们干脆让设备驱动程序来决定，因为它是最了解设备的。这里我们让这个 intfltdsc_t 结构上的所有中断处理函数都依次执行，查看是不是自己的设备产生了中断，如果是就处理，不是则略过。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">//定义intfltdsc_t结构数组大小为256</span>
<span class="token function">HAL_DEFGLOB_VARIABLE</span><span class="token punctuation">(</span><span class="token class-name">intfltdsc_t</span><span class="token punctuation">,</span>machintflt<span class="token punctuation">)</span><span class="token punctuation">[</span>IDTMAX<span class="token punctuation">]</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>



<p>实现中断异常分发函数</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">//中断处理函数</span>
<span class="token keyword">void</span> <span class="token function">hal_do_hwint</span><span class="token punctuation">(</span><span class="token class-name">uint_t</span> intnumb<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>krnlsframp<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>    
    <span class="token class-name">intfltdsc_t</span> <span class="token operator">*</span>ifdscp <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>    
    <span class="token class-name">cpuflg_t</span> cpuflg<span class="token punctuation">;</span>
    <span class="token comment">//根据中断号获取中断异常描述符地址    </span>
    ifdscp <span class="token operator">=</span> <span class="token function">hal_retn_intfltdsc</span><span class="token punctuation">(</span>intnumb<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//对断异常描述符加锁并中断    </span>
    <span class="token function">hal_spinlock_saveflg_cli</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ifdscp<span class="token operator">-></span>i_lock<span class="token punctuation">,</span> <span class="token operator">&amp;</span>cpuflg<span class="token punctuation">)</span><span class="token punctuation">;</span>    
    ifdscp<span class="token operator">-></span>i_indx<span class="token operator">++</span><span class="token punctuation">;</span>    
    ifdscp<span class="token operator">-></span>i_deep<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token comment">//运行中断处理的回调函数</span>
    <span class="token function">hal_run_intflthandle</span><span class="token punctuation">(</span>intnumb<span class="token punctuation">,</span> krnlsframp<span class="token punctuation">)</span><span class="token punctuation">;</span>    
    ifdscp<span class="token operator">-></span>i_deep<span class="token operator">--</span><span class="token punctuation">;</span>
    <span class="token comment">//解锁并恢复中断状态    </span>
    <span class="token function">hal_spinunlock_restflg_sti</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ifdscp<span class="token operator">-></span>i_lock<span class="token punctuation">,</span> <span class="token operator">&amp;</span>cpuflg<span class="token punctuation">)</span><span class="token punctuation">;</span>    
    <span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token comment">//异常分发器</span>
<span class="token keyword">void</span> <span class="token function">hal_fault_allocator</span><span class="token punctuation">(</span><span class="token class-name">uint_t</span> faultnumb<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>krnlsframp<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token comment">//我们的异常处理回调函数也是放在中断异常描述符中的</span>
    <span class="token function">hal_do_hwint</span><span class="token punctuation">(</span>faultnumb<span class="token punctuation">,</span> krnlsframp<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token comment">//中断分发器</span>
<span class="token keyword">void</span> <span class="token function">hal_hwint_allocator</span><span class="token punctuation">(</span><span class="token class-name">uint_t</span> intnumb<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>krnlsframp<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token function">hal_do_hwint</span><span class="token punctuation">(</span>intnumb<span class="token punctuation">,</span> krnlsframp<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>hal_run_intflthandle负责调用中断处理函数</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">hal_run_intflthandle</span><span class="token punctuation">(</span><span class="token class-name">uint_t</span> ifdnr<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>sframe<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>    
    <span class="token class-name">intserdsc_t</span> <span class="token operator">*</span>isdscp<span class="token punctuation">;</span>    
    <span class="token class-name">list_h_t</span> <span class="token operator">*</span>lst<span class="token punctuation">;</span>
    <span class="token comment">//根据中断号获取中断异常描述符地址    </span>
    <span class="token class-name">intfltdsc_t</span> <span class="token operator">*</span>ifdscp <span class="token operator">=</span> <span class="token function">hal_retn_intfltdsc</span><span class="token punctuation">(</span>ifdnr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//遍历i_serlist链表    </span>
    <span class="token function">list_for_each</span><span class="token punctuation">(</span>lst<span class="token punctuation">,</span> <span class="token operator">&amp;</span>ifdscp<span class="token operator">-></span>i_serlist<span class="token punctuation">)</span>    
    <span class="token punctuation">&#123;</span>   
        <span class="token comment">//获取i_serlist链表上对象即intserdsc_t结构</span>
        isdscp <span class="token operator">=</span> <span class="token function">list_entry</span><span class="token punctuation">(</span>lst<span class="token punctuation">,</span> <span class="token class-name">intserdsc_t</span><span class="token punctuation">,</span> s_list<span class="token punctuation">)</span><span class="token punctuation">;</span>  
        <span class="token comment">//调用中断处理回调函数      </span>
        isdscp<span class="token operator">-></span><span class="token function">s_handle</span><span class="token punctuation">(</span>ifdnr<span class="token punctuation">,</span> isdscp<span class="token operator">-></span>s_device<span class="token punctuation">,</span> sframe<span class="token punctuation">)</span><span class="token punctuation">;</span>    
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="初始化中断控制器"><a href="#初始化中断控制器" class="headerlink" title="初始化中断控制器"></a>初始化中断控制器</h3><p>把 CPU 端的中断搞定了以后，还有设备端的中断，这个可以交给设备驱动程序，但是 CPU 和设备之间的中断控制器，还需要我们出面解决。</p>
<p>多个设备的中断信号线都会连接到中断控制器上，中断控制器可以决定启用或者屏蔽哪些设备的中断，还可以决定设备中断之间的优先线，所以它才叫中断控制器</p>
<p>x86 平台上的中断控制器有多种，最开始是 8259A，然后是 IOAPIC，最新的是 MSI-X。为了简单的说明原理，我们选择了 8259A 中断控制器。</p>
<p>8259A 在任何 x86 平台上都可以使用，x86 平台使用了两片 8259A 芯片，以级联的方式存在。它拥有 15 个中断源（即可以有 15 个中断信号接入）。</p>
<p><img src="https://static001.geekbang.org/resource/image/4d/09/4d81f7feb668abf30c5cced619549709.jpg" alt="8259A控制器框架图"></p>
<p>上面直接和 CPU 连接的是主 8259A，下面的是从 8259A，每一个 8259A 芯片都有两个 I/O 端口，我们可以通过它们对 8259A 进行编程。</p>
<p>主 8259A 的端口地址是 0x20，0x21；从 8259A 的端口地址是 0xA0，0xA1</p>
<p>下面我们来做代码初始化，我们程序员可以向 8259A 写两种命令字： ICW 和 OCW；ICW 这种命令字用来实现 8259a 芯片的初始化。而 OCW 这种命令用来向 8259A 发布命令，以对其进行控制。OCW 可以在 8259A 被初始化之后的任何时候被使用</p>
<p>8259.c</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">init_i8259</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token comment">//初始化主从8259a</span>
    <span class="token function">out_u8_p</span><span class="token punctuation">(</span>ZIOPT<span class="token punctuation">,</span> ICW1<span class="token punctuation">)</span><span class="token punctuation">;</span>    
    <span class="token function">out_u8_p</span><span class="token punctuation">(</span>SIOPT<span class="token punctuation">,</span> ICW1<span class="token punctuation">)</span><span class="token punctuation">;</span>    
    <span class="token function">out_u8_p</span><span class="token punctuation">(</span>ZIOPT1<span class="token punctuation">,</span> ZICW2<span class="token punctuation">)</span><span class="token punctuation">;</span>    
    <span class="token function">out_u8_p</span><span class="token punctuation">(</span>SIOPT1<span class="token punctuation">,</span> SICW2<span class="token punctuation">)</span><span class="token punctuation">;</span>    
    <span class="token function">out_u8_p</span><span class="token punctuation">(</span>ZIOPT1<span class="token punctuation">,</span> ZICW3<span class="token punctuation">)</span><span class="token punctuation">;</span>    
    <span class="token function">out_u8_p</span><span class="token punctuation">(</span>SIOPT1<span class="token punctuation">,</span> SICW3<span class="token punctuation">)</span><span class="token punctuation">;</span>    
    <span class="token function">out_u8_p</span><span class="token punctuation">(</span>ZIOPT1<span class="token punctuation">,</span> ICW4<span class="token punctuation">)</span><span class="token punctuation">;</span>    
    <span class="token function">out_u8_p</span><span class="token punctuation">(</span>SIOPT1<span class="token punctuation">,</span> ICW4<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//屏蔽全部中断源</span>
    <span class="token function">out_u8_p</span><span class="token punctuation">(</span>ZIOPT1<span class="token punctuation">,</span> <span class="token number">0xff</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    
    <span class="token function">out_u8_p</span><span class="token punctuation">(</span>SIOPT1<span class="token punctuation">,</span> <span class="token number">0xff</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        
    <span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="进入内核层"><a href="#进入内核层" class="headerlink" title="进入内核层"></a>进入内核层</h3><p>由于内核层是从 hal 层进入的，必须在 hal_start() 函数中被调用，所以在此完成这个函数——init_krl()</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">init_krl</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span> 
    <span class="token comment">//禁止函数返回    </span>
    <span class="token function">die</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    
    <span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>调用</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">hal_start</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>   
    <span class="token comment">//初始化hal层 </span>
    <span class="token function">init_hal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//初始化内核层    </span>
    <span class="token function">init_krl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    
    <span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><blockquote>
<p>一、HAL层调用链<br>hal_start()</p>
<p>A、先去处理HAL层的初始化<br>-&gt;init_hal()</p>
<p>-&gt;-&gt;init_halplaltform()初始化平台<br>-&gt;-&gt;-&gt;init_machbstart()<br>主要是把二级引导器建立的机器信息结构，复制到了hal层一份给内核使用，同时也为释放二级引导器占用内存做好准备。<br>其做法就是拷贝了一份mbsp到kmbsp，其中用到了虚拟地址转换hyadr_to_viradr<br>-&gt;-&gt;-&gt;init_bdvideo()<br>初始化图形机构<br>初始化BGA显卡 或 VBE图形显卡信息【函数指针的使用】<br>清空屏幕<br>找到”background.bmp”，并显示背景图片<br>-&gt;-&gt;-&gt;-&gt;hal_dspversion（）<br>输出版本号等信息【vsprintfk】<br>其中，用ret_charsinfo根据字体文件获取字符像素信息</p>
<p>-&gt;-&gt;move_img2maxpadr()<br>将移动initldrsve.bin到最大地址</p>
<p>-&gt;-&gt;init_halmm()初始化内存<br>-&gt;-&gt;-&gt;init_phymmarge<br>申请phymmarge_t内存<br>根据 e820map_t 结构数组，复制数据到phymmarge_t 结构数组<br>按内存开始地址进行排序</p>
<p>-&gt;-&gt;init_halintupt();初始化中断<br>-&gt;-&gt;-&gt;init_descriptor();初始化GDT描述符x64_gdt<br>-&gt;-&gt;-&gt;init_idt_descriptor();初始化IDT描述符x64_idt，绑定了中断编号及中断处理函数<br>-&gt;-&gt;-&gt;init_intfltdsc();初始化中断异常表machintflt，拷贝了中断相关信息<br>-&gt;-&gt;-&gt;init_i8259();初始化8529芯片中断<br>-&gt;-&gt;-&gt;i8259_enabled_line(0);好像是取消mask，开启中断请求</p>
<p>最后，跳转去处理内核初始化<br>-&gt;init_krl()</p>
<p>二、中断调用链，以硬件中断为例<br>A、kernel.inc中，通过宏定义，进行了中断定义。以硬件中断为例，可以在kernel.inc中看到：<br>宏为HARWINT，硬件中断分发器函数为hal_hwint_allocator<br>%macro HARWINT 1<br>  保存现场……<br>  mov rdi, %1<br>  mov rsi,rsp<br>  call hal_hwint_allocator<br>  恢复现场……<br>%endmacro</p>
<p>B、而在kernel.asm中，定义了各种硬件中断编号，比如hxi_hwint00，作为中断处理入口<br>ALIGN 16<br>hxi_hwint00:<br>  HARWINT (INT_VECTOR_IRQ0+0)</p>
<p>C、有硬件中断时，会先到达中断处理入口，然后调用到硬件中断分发器函数hal_hwint_allocator<br>第一个参数为中断编号，在rdi<br>第二个参数为中断发生时的栈指针，在rsi<br>然后调用异常处理函数hal_do_hwint</p>
<p>D、hal_do_hwint<br>加锁<br>调用中断回调函数hal_run_intflthandle<br>释放锁</p>
<p>E、hal_run_intflthandle<br>先获取中断异常表machintflt<br>然后调用i_serlist 链表上所有挂载intserdsc_t 结构中的中断处理的回调函数，是否处理由函数自己判断</p>
<p>F、中断处理完毕</p>
<p>G、异常处理类似，只是触发源头不太一样而已</p>
</blockquote>

                
            </div>
            <hr/>

            

    <div class="reprint" id="reprint-statement">
        
            <div class="reprint__author">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-user">
                        文章作者:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="/about" rel="external nofollow noreferrer">InnovationLou</a>
                </span>
            </div>
            <div class="reprint__type">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-link">
                        文章链接:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="https://blog.innnovation.cn/2021/07/05/cao-zuo-xi-tong-di-yi-ge-c-han-shu-shi-xian-ban-ji-chu-shi-hua/">https://blog.innnovation.cn/2021/07/05/cao-zuo-xi-tong-di-yi-ge-c-han-shu-shi-xian-ban-ji-chu-shi-hua/</a>
                </span>
            </div>
            <div class="reprint__notice">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-copyright">
                        版权声明:
                    </i>
                </span>
                <span class="reprint-info">
                    本博客所有文章除特別声明外，均采用
                    <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a>
                    许可协议。转载请注明来源
                    <a href="/about" target="_blank">InnovationLou</a>
                    !
                </span>
            </div>
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            
                                <a href="/tags/OS/">
                                    <span class="chip bg-color">OS</span>
                                </a>
                            
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">
<div id="article-share">

    
    <div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    

</div>

                </div>
            </div>
            
                <style>
    #reward {
        margin: 40px 0;
        text-align: center;
    }

    #reward .reward-link {
        font-size: 1.4rem;
        line-height: 38px;
    }

    #reward .btn-floating:hover {
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2), 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    #rewardModal {
        width: 320px;
        height: 350px;
    }

    #rewardModal .reward-title {
        margin: 15px auto;
        padding-bottom: 5px;
    }

    #rewardModal .modal-content {
        padding: 10px;
    }

    #rewardModal .close {
        position: absolute;
        right: 15px;
        top: 15px;
        color: rgba(0, 0, 0, 0.5);
        font-size: 1.3rem;
        line-height: 20px;
        cursor: pointer;
    }

    #rewardModal .close:hover {
        color: #ef5350;
        transform: scale(1.3);
        -moz-transform:scale(1.3);
        -webkit-transform:scale(1.3);
        -o-transform:scale(1.3);
    }

    #rewardModal .reward-tabs {
        margin: 0 auto;
        width: 210px;
    }

    .reward-tabs .tabs {
        height: 38px;
        margin: 10px auto;
        padding-left: 0;
    }

    .reward-content ul {
        padding-left: 0 !important;
    }

    .reward-tabs .tabs .tab {
        height: 38px;
        line-height: 38px;
    }

    .reward-tabs .tab a {
        color: #fff;
        background-color: #ccc;
    }

    .reward-tabs .tab a:hover {
        background-color: #ccc;
        color: #fff;
    }

    .reward-tabs .wechat-tab .active {
        color: #fff !important;
        background-color: #22AB38 !important;
    }

    .reward-tabs .alipay-tab .active {
        color: #fff !important;
        background-color: #019FE8 !important;
    }

    .reward-tabs .reward-img {
        width: 210px;
        height: 210px;
    }
</style>

<div id="reward">
    <a href="#rewardModal" class="reward-link modal-trigger btn-floating btn-medium waves-effect waves-light red">赏</a>

    <!-- Modal Structure -->
    <div id="rewardModal" class="modal">
        <div class="modal-content">
            <a class="close modal-close"><i class="fas fa-times"></i></a>
            <h4 class="reward-title">你的赏识是我前进的动力</h4>
            <div class="reward-content">
                <div class="reward-tabs">
                    <ul class="tabs row">
                        <li class="tab col s6 alipay-tab waves-effect waves-light"><a href="#alipay">支付宝</a></li>
                        <li class="tab col s6 wechat-tab waves-effect waves-light"><a href="#wechat">微 信</a></li>
                    </ul>
                    <div id="alipay">
                        <img src="/medias/reward/alipay.jpg" class="reward-img" alt="支付宝打赏二维码">
                    </div>
                    <div id="wechat">
                        <img src="/medias/reward/wechat.png" class="reward-img" alt="微信打赏二维码">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(function () {
        $('.tabs').tabs();
    });
</script>

            
        </div>
    </div>

    

    

    

    

    
        <style>
    .valine-card {
        margin: 1.5rem auto;
    }

    .valine-card .card-content {
        padding: 20px 20px 5px 20px;
    }

    #vcomments textarea {
        box-sizing: border-box;
        background: url("/medias/comment_bg.png") 100% 100% no-repeat;
    }

    #vcomments p {
        margin: 2px 2px 10px;
        font-size: 1.05rem;
        line-height: 1.78rem;
    }

    #vcomments blockquote p {
        text-indent: 0.2rem;
    }

    #vcomments a {
        padding: 0 2px;
        color: #4cbf30;
        font-weight: 500;
        text-decoration: none;
    }

    #vcomments img {
        max-width: 100%;
        height: auto;
        cursor: pointer;
    }

    #vcomments ol li {
        list-style-type: decimal;
    }

    #vcomments ol,
    ul {
        display: block;
        padding-left: 2em;
        word-spacing: 0.05rem;
    }

    #vcomments ul li,
    ol li {
        display: list-item;
        line-height: 1.8rem;
        font-size: 1rem;
    }

    #vcomments ul li {
        list-style-type: disc;
    }

    #vcomments ul ul li {
        list-style-type: circle;
    }

    #vcomments table, th, td {
        padding: 12px 13px;
        border: 1px solid #dfe2e5;
    }

    #vcomments table, th, td {
        border: 0;
    }

    table tr:nth-child(2n), thead {
        background-color: #fafafa;
    }

    #vcomments table th {
        background-color: #f2f2f2;
        min-width: 80px;
    }

    #vcomments table td {
        min-width: 80px;
    }

    #vcomments h1 {
        font-size: 1.85rem;
        font-weight: bold;
        line-height: 2.2rem;
    }

    #vcomments h2 {
        font-size: 1.65rem;
        font-weight: bold;
        line-height: 1.9rem;
    }

    #vcomments h3 {
        font-size: 1.45rem;
        font-weight: bold;
        line-height: 1.7rem;
    }

    #vcomments h4 {
        font-size: 1.25rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    #vcomments h5 {
        font-size: 1.1rem;
        font-weight: bold;
        line-height: 1.4rem;
    }

    #vcomments h6 {
        font-size: 1rem;
        line-height: 1.3rem;
    }

    #vcomments p {
        font-size: 1rem;
        line-height: 1.5rem;
    }

    #vcomments hr {
        margin: 12px 0;
        border: 0;
        border-top: 1px solid #ccc;
    }

    #vcomments blockquote {
        margin: 15px 0;
        border-left: 5px solid #42b983;
        padding: 1rem 0.8rem 0.3rem 0.8rem;
        color: #666;
        background-color: rgba(66, 185, 131, .1);
    }

    #vcomments pre {
        font-family: monospace, monospace;
        padding: 1.2em;
        margin: .5em 0;
        background: #272822;
        overflow: auto;
        border-radius: 0.3em;
        tab-size: 4;
    }

    #vcomments code {
        font-family: monospace, monospace;
        padding: 1px 3px;
        font-size: 0.92rem;
        color: #e96900;
        background-color: #f8f8f8;
        border-radius: 2px;
    }

    #vcomments pre code {
        font-family: monospace, monospace;
        padding: 0;
        color: #e8eaf6;
        background-color: #272822;
    }

    #vcomments pre[class*="language-"] {
        padding: 1.2em;
        margin: .5em 0;
    }

    #vcomments code[class*="language-"],
    pre[class*="language-"] {
        color: #e8eaf6;
    }

    #vcomments [type="checkbox"]:not(:checked), [type="checkbox"]:checked {
        position: inherit;
        margin-left: -1.3rem;
        margin-right: 0.4rem;
        margin-top: -1px;
        vertical-align: middle;
        left: unset;
        visibility: visible;
    }

    #vcomments b,
    strong {
        font-weight: bold;
    }

    #vcomments dfn {
        font-style: italic;
    }

    #vcomments small {
        font-size: 85%;
    }

    #vcomments cite {
        font-style: normal;
    }

    #vcomments mark {
        background-color: #fcf8e3;
        padding: .2em;
    }

    #vcomments table, th, td {
        padding: 12px 13px;
        border: 1px solid #dfe2e5;
    }

    table tr:nth-child(2n), thead {
        background-color: #fafafa;
    }

    #vcomments table th {
        background-color: #f2f2f2;
        min-width: 80px;
    }

    #vcomments table td {
        min-width: 80px;
    }

    #vcomments [type="checkbox"]:not(:checked), [type="checkbox"]:checked {
        position: inherit;
        margin-left: -1.3rem;
        margin-right: 0.4rem;
        margin-top: -1px;
        vertical-align: middle;
        left: unset;
        visibility: visible;
    }
</style>

<div class="card valine-card" data-aos="fade-up">
    <div class="comment_headling" style="font-size: 20px; font-weight: 700; position: relative; padding-left: 20px; top: 15px; padding-bottom: 5px;">
        <i class="fas fa-comments fa-fw" aria-hidden="true"></i>
        <span>评论</span>
    </div>
    <div id="vcomments" class="card-content" style="display: grid">
    </div>
</div>

<script src="/libs/valine/av-min.js"></script>
<script src="/libs/valine/Valine.min.js"></script>
<script>
    new Valine({
        el: '#vcomments',
        appId: 'fy7ueoJB3J52dljzYYK6ERow-gzGzoHsz',
        appKey: 'TYe6GIHTfcxvwM9MUBdQPUvg',
        notify: 'false' === 'true',
        verify: 'false' === 'true',
        visitor: 'true' === 'true',
        avatar: 'mm',
        pageSize: '10',
        lang: 'zh-cn',
        placeholder: 'just go go'
    });
</script>

<!--酷Q推送-->


    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fas fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/2021/07/07/git-shi-yong-fu-xi-jin-jie-su-cha-shou-ce/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/1.jpg" class="responsive-img" alt="git复习进阶及命令速查">
                        
                        <span class="card-title">git复习进阶及命令速查</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="far fa-clock fa-fw icon-date"></i>2021-07-07
                        </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/%E6%9D%82%E9%A1%B9/" class="post-category">
                                    杂项
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/%E6%9D%82%E9%A1%B9/">
                        <span class="chip bg-color">杂项</span>
                    </a>
                    
                    <a href="/tags/GIT/">
                        <span class="chip bg-color">GIT</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2021/06/25/cao-zuo-xi-tong-she-zhi-gong-zuo-mo-shi-yu-huan-jing/">
                    <div class="card-image">
                        
                        <img src="https://pic.innnovation.cn//img/20210625223502.png" class="responsive-img" alt="操作系统-硬件到软件启动初始化-设置工作模式与环境">
                        
                        <span class="card-title">操作系统-硬件到软件启动初始化-设置工作模式与环境</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2021-06-25
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/" class="post-category">
                                    操作系统
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/OS/">
                        <span class="chip bg-color">OS</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>


<script>
    $('#articleContent').on('copy', function (e) {
        // IE8 or earlier browser is 'undefined'
        if (typeof window.getSelection === 'undefined') return;

        var selection = window.getSelection();
        // if the selection is short let's not annoy our users.
        if (('' + selection).length < Number.parseInt('120')) {
            return;
        }

        // create a div outside of the visible area and fill it with the selected text.
        var bodyElement = document.getElementsByTagName('body')[0];
        var newdiv = document.createElement('div');
        newdiv.style.position = 'absolute';
        newdiv.style.left = '-99999px';
        bodyElement.appendChild(newdiv);
        newdiv.appendChild(selection.getRangeAt(0).cloneContents());

        // we need a <pre> tag workaround.
        // otherwise the text inside "pre" loses all the line breaks!
        if (selection.getRangeAt(0).commonAncestorContainer.nodeName === 'PRE') {
            newdiv.innerHTML = "<pre>" + newdiv.innerHTML + "</pre>";
        }

        var url = document.location.href;
        newdiv.innerHTML += '<br />'
            + '来源: Innovation Louke<br />'
            + '文章作者: InnovationLou<br />'
            + '文章链接: <a href="' + url + '">' + url + '</a><br />'
            + '本文章著作权归作者所有，任何形式的转载都请注明出处。';

        selection.selectAllChildren(newdiv);
        window.setTimeout(function () {bodyElement.removeChild(newdiv);}, 200);
    });
</script>


<!-- 代码块功能依赖 -->
<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>

<!-- 代码语言 -->

<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>


<!-- 代码块复制 -->

<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script>


    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget card" style="background-color: white;">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('0'),
            headingSelector: 'h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>




    <footer class="page-footer bg-color">
    
        <link rel="stylesheet" href="/libs/aplayer/APlayer.min.css">
<style>
    .aplayer .aplayer-lrc p {
        
        display: none;
        
        font-size: 12px;
        font-weight: 700;
        line-height: 16px !important;
    }

    .aplayer .aplayer-lrc p.aplayer-lrc-current {
        
        display: none;
        
        font-size: 15px;
        color: #42b983;
    }

    
    .aplayer.aplayer-fixed.aplayer-narrow .aplayer-body {
        left: -66px !important;
    }

    .aplayer.aplayer-fixed.aplayer-narrow .aplayer-body:hover {
        left: 0px !important;
    }

    
</style>
<div class="">
    
    <div class="row">
        <meting-js class="col l8 offset-l2 m10 offset-m1 s12"
                   server="netease"
                   type="playlist"
                   id="503838841"
                   fixed='true'
                   autoplay='false'
                   theme='#42b983'
                   loop='all'
                   order='random'
                   preload='auto'
                   volume='0.7'
                   list-folded='true'
        >
        </meting-js>
    </div>
</div>

<script src="/libs/aplayer/APlayer.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/meting@2/dist/Meting.min.js"></script>

    

    <div class="container row center-align"
         style="margin-bottom: 15px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            
                <span id="year">2021</span>
            
            <span id="year">2021</span>
            <a href="/about" target="_blank">InnovationLou</a>
            |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>
            <br>
            
            
            
                
            
            
                <span id="busuanzi_container_site_pv">
                &nbsp;|&nbsp;<i class="far fa-eye"></i>&nbsp;总访问量:&nbsp;
                    <span id="busuanzi_value_site_pv" class="white-color"></span>
            </span>
            
            
                <span id="busuanzi_container_site_uv">
                &nbsp;|&nbsp;<i class="fas fa-users"></i>&nbsp;总访问人数:&nbsp;
                    <span id="busuanzi_value_site_uv" class="white-color"></span>
            </span>
            
            <br>

            <!-- 运行天数提醒. -->
            
                <span id="sitetime"> Loading ...</span>
                <script>
                    var calcSiteTime = function () {
                        var seconds = 1000;
                        var minutes = seconds * 60;
                        var hours = minutes * 60;
                        var days = hours * 24;
                        var years = days * 365;
                        var today = new Date();
                        var startYear = "2021";
                        var startMonth = "6";
                        var startDate = "7";
                        var startHour = "0";
                        var startMinute = "0";
                        var startSecond = "0";
                        var todayYear = today.getFullYear();
                        var todayMonth = today.getMonth() + 1;
                        var todayDate = today.getDate();
                        var todayHour = today.getHours();
                        var todayMinute = today.getMinutes();
                        var todaySecond = today.getSeconds();
                        var t1 = Date.UTC(startYear, startMonth, startDate, startHour, startMinute, startSecond);
                        var t2 = Date.UTC(todayYear, todayMonth, todayDate, todayHour, todayMinute, todaySecond);
                        var diff = t2 - t1;
                        var diffYears = Math.floor(diff / years);
                        var diffDays = Math.floor((diff / days) - diffYears * 365);

                        // 区分是否有年份.
                        var language = 'zh-CN';
                        if (startYear === String(todayYear)) {
                            document.getElementById("year").innerHTML = todayYear;
                            var daysTip = 'This site has been running for ' + diffDays + ' days';
                            if (language === 'zh-CN') {
                                daysTip = '本站已运行 ' + diffDays + ' 天';
                            } else if (language === 'zh-HK') {
                                daysTip = '本站已運行 ' + diffDays + ' 天';
                            }
                            document.getElementById("sitetime").innerHTML = daysTip;
                        } else {
                            document.getElementById("year").innerHTML = startYear + " - " + todayYear;
                            var yearsAndDaysTip = 'This site has been running for ' + diffYears + ' years and '
                                + diffDays + ' days';
                            if (language === 'zh-CN') {
                                yearsAndDaysTip = '本站已运行 ' + diffYears + ' 年 ' + diffDays + ' 天';
                            } else if (language === 'zh-HK') {
                                yearsAndDaysTip = '本站已運行 ' + diffYears + ' 年 ' + diffDays + ' 天';
                            }
                            document.getElementById("sitetime").innerHTML = yearsAndDaysTip;
                        }
                    }

                    calcSiteTime();
                </script>
            
            <br>
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">


    <a href="mailto:1181062873@qq.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fas fa-envelope-open"></i>
    </a>



    <a href="https://www.facebook.com/lou.innovation/" class="tooltipped" target="_blank" data-tooltip="关注我的Facebook: https://www.facebook.com/lou.innovation/" data-position="top" data-delay="50">
        <i class="fab fa-facebook-f"></i>
    </a>



    <a href="https://twitter.com/innovationLou" class="tooltipped" target="_blank" data-tooltip="关注我的Twitter: https://twitter.com/innovationLou" data-position="top" data-delay="50">
        <i class="fab fa-twitter"></i>
    </a>



    <a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=578777205" class="tooltipped" target="_blank" data-tooltip="QQ联系我: 578777205" data-position="top" data-delay="50">
        <i class="fab fa-qq"></i>
    </a>







</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script type="text/javascript">
$(function () {
    var searchFunc = function (path, search_id, content_id) {
        'use strict';
        $.ajax({
            url: path,
            dataType: "xml",
            success: function (xmlResponse) {
                // get the contents from search data
                var datas = $("entry", xmlResponse).map(function () {
                    return {
                        title: $("title", this).text(),
                        content: $("content", this).text(),
                        url: $("url", this).text()
                    };
                }).get();
                var $input = document.getElementById(search_id);
                var $resultContent = document.getElementById(content_id);
                $input.addEventListener('input', function () {
                    var str = '<ul class=\"search-result-list\">';
                    var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                    $resultContent.innerHTML = "";
                    if (this.value.trim().length <= 0) {
                        return;
                    }
                    // perform local searching
                    datas.forEach(function (data) {
                        var isMatch = true;
                        var data_title = data.title.trim().toLowerCase();
                        var data_content = data.content.trim().replace(/<[^>]+>/g, "").toLowerCase();
                        var data_url = data.url;
                        data_url = data_url.indexOf('/') === 0 ? data.url : '/' + data_url;
                        var index_title = -1;
                        var index_content = -1;
                        var first_occur = -1;
                        // only match artiles with not empty titles and contents
                        if (data_title !== '' && data_content !== '') {
                            keywords.forEach(function (keyword, i) {
                                index_title = data_title.indexOf(keyword);
                                index_content = data_content.indexOf(keyword);
                                if (index_title < 0 && index_content < 0) {
                                    isMatch = false;
                                } else {
                                    if (index_content < 0) {
                                        index_content = 0;
                                    }
                                    if (i === 0) {
                                        first_occur = index_content;
                                    }
                                }
                            });
                        }
                        // show search results
                        if (isMatch) {
                            str += "<li><a href='" + data_url + "' class='search-result-title'>" + data_title + "</a>";
                            var content = data.content.trim().replace(/<[^>]+>/g, "");
                            if (first_occur >= 0) {
                                // cut out 100 characters
                                var start = first_occur - 20;
                                var end = first_occur + 80;
                                if (start < 0) {
                                    start = 0;
                                }
                                if (start === 0) {
                                    end = 100;
                                }
                                if (end > content.length) {
                                    end = content.length;
                                }
                                var match_content = content.substr(start, end);
                                // highlight all keywords
                                keywords.forEach(function (keyword) {
                                    var regS = new RegExp(keyword, "gi");
                                    match_content = match_content.replace(regS, "<em class=\"search-keyword\">" + keyword + "</em>");
                                });

                                str += "<p class=\"search-result\">" + match_content + "...</p>"
                            }
                            str += "</li>";
                        }
                    });
                    str += "</ul>";
                    $resultContent.innerHTML = str;
                });
            }
        });
    };

    searchFunc('/search.xml', 'searchInput', 'searchResult');
});
</script>

    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

<script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    
    <script src="/libs/others/clicklove.js" async="async"></script>
    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    

    

    <!--腾讯兔小巢-->
    
    

    

    

    
    <script src="/libs/instantpage/instantpage.js" type="module"></script>
    

</body>

</html>
